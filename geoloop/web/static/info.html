<!DOCTYPE html>
<html lang="nb">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoLoop — Systeminformasjon</title>
    <link rel="stylesheet" href="/static/style.css?v=6">
</head>
<body>
    <header>
        <h1><a href="/" class="header-link">GeoLoop</a></h1>
        <nav class="nav-links">
            <a href="/">Dashboard</a>
            <a href="/info" class="active">System</a>
        </nav>
    </header>

    <main>
        <section class="card">
            <h2>System</h2>
            <table class="kv-table" id="system-tbl">
                <tr><td colspan="2" class="meta">Laster...</td></tr>
            </table>
        </section>

        <section class="card">
            <h2>Anlegg</h2>
            <table class="kv-table" id="loop-tbl">
                <tr><td colspan="2" class="meta">Laster...</td></tr>
            </table>
        </section>

        <section class="card">
            <h2>Temperatursensorer</h2>
            <div class="info-table-wrap">
                <table class="info-table">
                    <thead>
                        <tr>
                            <th>Sensor</th>
                            <th>Posisjon</th>
                            <th>Temperatur nå</th>
                        </tr>
                    </thead>
                    <tbody id="sensor-tbody">
                        <tr><td colspan="3" class="meta">Laster...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card">
            <h2>Reléer</h2>
            <div class="info-table-wrap">
                <table class="info-table">
                    <thead>
                        <tr>
                            <th>Kanal</th>
                            <th>GPIO-pinne</th>
                            <th>Tilkobling</th>
                        </tr>
                    </thead>
                    <tbody id="relay-tbody">
                        <tr><td colspan="3" class="meta">Laster...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card">
            <h2>Styringslogikk</h2>
            <p class="info-description">
                GeoLoop bruker prediktiv styring basert på 24-timers værprognose fra
                <strong>api.met.no</strong>. Systemet evaluerer isrisiko automatisk.
            </p>
            <div class="info-table-wrap">
                <table class="info-table">
                    <thead>
                        <tr>
                            <th>Risikonivå</th>
                            <th>Kriterier</th>
                            <th>Handling</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="risk-badge risk-high">HØY</span></td>
                            <td>Nedbør nær 0°C, eller ≥4t i -1 til +2°C</td>
                            <td>Slå PÅ</td>
                        </tr>
                        <tr>
                            <td><span class="risk-badge risk-moderate">MODERAT</span></td>
                            <td>≥6 timer i issonen (-5 til +5°C)</td>
                            <td>Slå PÅ</td>
                        </tr>
                        <tr>
                            <td><span class="risk-badge risk-low">LAV</span></td>
                            <td>≥2 timer i issonen</td>
                            <td>Behold tilstand</td>
                        </tr>
                        <tr>
                            <td><span class="risk-badge risk-none">INGEN</span></td>
                            <td>&lt; 2 timer i issonen</td>
                            <td>Slå AV</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card">
            <h2>Database</h2>
            <table class="kv-table" id="db-tbl">
                <tr><td colspan="2" class="meta">Laster...</td></tr>
            </table>
        </section>
    </main>

    <script>
    (function () {
        "use strict";

        var SENSOR_NAMES = {
            loop_inlet:  "Sløyfe inn (T1)",
            loop_outlet: "Sløyfe ut (T2)",
            hp_inlet:    "VP inn (T3)",
            hp_outlet:   "VP ut (T4)",
            tank:        "Tank (T5)"
        };
        var SENSOR_LOCATIONS = {
            loop_inlet:  "Tank \u2192 bakkesl\u00f8yfe \u2014 turtemperatur til bakken",
            loop_outlet: "Bakkesl\u00f8yfe \u2192 tank \u2014 returtemperatur (delta-T)",
            hp_inlet:    "Tank \u2192 VP (via kolbetank) \u2014 returvann til VP",
            hp_outlet:   "VP \u2192 tank \u2014 turvann fra VP",
            tank:        "Buffertank 200 L (VP klemme 15/16)"
        };
        var RELAY_NAMES = {
            heat_pump:        "Varmepumpe (K1)",
            circulation_pump: "Sirkulasjonspumpe (K2)",
            spare:            "Ledig (K3)"
        };
        var RELAY_CONNECTIONS = {
            heat_pump:        "VP klemme 17/18 (potensialfri, erstatter fabrikkjumper)",
            circulation_pump: "Uavhengig styring",
            spare:            "Reservert (kolber i fremtiden)"
        };

        function fetchJSON(url) {
            return fetch(url).then(function (r) { return r.json(); });
        }

        function kv(rows) {
            var html = "";
            for (var i = 0; i < rows.length; i++) {
                html += "<tr><td>" + rows[i][0] + "</td><td>" + rows[i][1] + "</td></tr>";
            }
            return html;
        }

        function fmtTemp(v) {
            if (v == null) return '<span class="meta">—</span>';
            return '<strong style="color:var(--warm)">' + v.toFixed(1) + " °C</strong>";
        }

        Promise.all([fetchJSON("/api/system"), fetchJSON("/api/status")])
        .then(function (res) {
            var d = res[0];
            var s = res[1];
            var temps = s.sensors || {};

            // System
            var sysRows = [
                ["Versjon", "GeoLoop v" + d.version],
                ["Posisjon", d.location.lat.toFixed(4) + "°N, " + d.location.lon.toFixed(4) + "°E"]
            ];
            sysRows.push(["Varmepumpe", "Panasonic WH-MXC12G6E5 (Aquarea G-gen, luft-vann)"]);
            sysRows.push(["Styringsenhet", "Raspberry Pi 3B+ + RPi Relay Board (3 kanaler)"]);
            if (d.weather) sysRows.push(["V\u00e6rdata-intervall", d.weather.poll_interval_minutes + " min"]);
            sysRows.push(["Sensorpolling", "1 min"]);
            sysRows.push(["Kontrollsyklus", "10 min"]);
            if (d.web) sysRows.push(["Webserver", d.web.host + ":" + d.web.port]);
            document.getElementById("system-tbl").innerHTML = kv(sysRows);

            // Anlegg
            var loopRows = [];
            if (d.ground_loop) {
                var gl = d.ground_loop;
                loopRows.push(["Antall sløyfer", gl.loops]);
                loopRows.push(["Total rørlengde", gl.total_length_m + " m"]);
                loopRows.push(["Rørdiameter (ytre/indre)", gl.pipe_outer_mm + " / " + (gl.pipe_outer_mm - 2 * gl.pipe_wall_mm) + " mm"]);
                loopRows.push(["Vannvolum, bakkesløyfe", "~" + gl.volume_liters + " liter"]);
                loopRows.push(["Legging", "I sand, 5 cm under overflaten, asfalt over"]);
                loopRows.push(["Dekket areal", "~90 m\u00b2"]);
                loopRows.push(["R\u00f8rtetthet", "~10 m/m\u00b2"]);
            }
            if (d.tank) {
                loopRows.push(["Buffertank", d.tank.volume_liters + " liter"]);
            }
            loopRows.push(["Kolbetank", "10 L (10 kW kolber p\u00e5 VP inngang)"]);
            loopRows.push(["Internr\u00f8r", "~30 liter"]);
            var totalVol = (d.ground_loop ? d.ground_loop.volume_liters : 0)
                         + (d.tank ? d.tank.volume_liters : 0) + 10 + 30;
            loopRows.push(["Totalt vannvolum", "~" + totalVol + " liter"]);
            document.getElementById("loop-tbl").innerHTML = loopRows.length
                ? kv(loopRows)
                : '<tr><td colspan="2" class="meta">Ikke konfigurert</td></tr>';

            // Sensorer
            var sHtml = "";
            if (d.sensors) {
                for (var key in d.sensors) {
                    sHtml += "<tr><td>" + (SENSOR_NAMES[key] || key) + "</td>" +
                             "<td>" + (SENSOR_LOCATIONS[key] || "") + "</td>" +
                             "<td>" + fmtTemp(temps[key]) + "</td></tr>";
                }
            } else {
                sHtml = '<tr><td colspan="3" class="meta">Ingen sensorer konfigurert</td></tr>';
            }
            document.getElementById("sensor-tbody").innerHTML = sHtml;

            // Reléer
            var rHtml = "";
            if (d.relays) {
                for (var key in d.relays) {
                    var r = d.relays[key];
                    rHtml += "<tr><td>" + (RELAY_NAMES[key] || key) + "</td>" +
                             "<td>GPIO " + r.gpio_pin + "</td>" +
                             "<td>" + (RELAY_CONNECTIONS[key] || (r.active_high ? "HIGH" : "LOW")) + "</td></tr>";
                }
            } else {
                rHtml = '<tr><td colspan="3" class="meta">Ingen rel\u00e9er konfigurert</td></tr>';
            }
            document.getElementById("relay-tbody").innerHTML = rHtml;

            // Database
            var dbRows = [];
            if (d.database) {
                dbRows.push(["Sensoravlesninger", d.database.sensor_readings.toLocaleString("nb-NO")]);
                dbRows.push(["Væravlesninger",    d.database.weather_readings.toLocaleString("nb-NO")]);
                dbRows.push(["Hendelser",         d.database.events.toLocaleString("nb-NO")]);
            }
            document.getElementById("db-tbl").innerHTML = dbRows.length
                ? kv(dbRows)
                : '<tr><td colspan="2" class="meta">Ikke tilgjengelig</td></tr>';
        })
        .catch(function () {
            document.getElementById("system-tbl").innerHTML =
                '<tr><td class="meta">Kunne ikke hente systeminformasjon</td></tr>';
        });
    })();
    </script>
</body>
</html>
